branch="$(git rev-parse --abbrev-ref HEAD)"
upstream="$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo '')"

# Allow commits to main if it's tracking origin/main, but block if tracking upstream/main
if [ "$branch" = "main" ]; then
  if [[ "$upstream" == *"origin/main" ]]; then
    echo "Allowing commit to main (tracking origin/main)"
  else
    echo "You can't commit directly to main - please check out a branch."
    exit 1
  fi
fi

# Detect if running on Windows and use pnpm.cmd, otherwise use pnpm.
if [ "$OS" = "Windows_NT" ]; then
  pnpm_cmd="pnpm.cmd"
else
  if command -v pnpm >/dev/null 2>&1; then
    pnpm_cmd="pnpm"
  else
    pnpm_cmd="npx pnpm"
  fi
fi

# Detect if running on Windows and use npx.cmd, otherwise use npx.
if [ "$OS" = "Windows_NT" ]; then
  npx_cmd="npx.cmd"
else
  npx_cmd="npx"
fi

$npx_cmd lint-staged
$pnpm_cmd lint

# Check if any docs/ files are staged for commit
if git diff --cached --name-only | grep -q "^docs/"; then
  echo "ğŸ“ Documentation files detected in staged changes. Running documentation validation..."
  
  # Documentation validation and fixing (unified approach)
  echo "ğŸ” Running unified documentation validation and fixing..."
  if ! $pnpm_cmd docs:fix; then
    echo "âŒ Documentation validation and fixing failed."
    echo "ğŸ’¡ The docs-fixer automatically fixes issues and validates. Check the output above."
    exit 1
  fi

  # Enhanced documentation validation
  echo "ğŸ” Running enhanced documentation validation..."
  if ! $pnpm_cmd docs:validate; then
    echo "âŒ Enhanced documentation validation failed."
    echo "ğŸ’¡ Check the validation output above for issues that need manual fixing."
    exit 1
  fi

  # Content quality analysis
  echo "ğŸ“Š Running content quality analysis..."
  if ! $pnpm_cmd docs:quality; then
    echo "âš ï¸  Content quality analysis completed with warnings."
    echo "ğŸ’¡ Consider improving content quality based on the analysis above."
  fi

  # Link validation
  echo "ğŸ”— Running link validation..."
  if ! $pnpm_cmd docs:links; then
    echo "âš ï¸  Link validation completed with warnings."
    echo "ğŸ’¡ Check the link validation output above for broken or problematic links."
  fi

  echo "âœ… Documentation validation and fixing completed successfully!"
else
  echo "â­ï¸  No documentation files in staged changes. Skipping documentation validation."
fi
